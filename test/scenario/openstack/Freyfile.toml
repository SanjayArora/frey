[infra.variable.FREY_OPENSTACK_TENANT_NAME]
[infra.variable.FREY_OPENSTACK_PROJECT_NAME]
[infra.variable.FREY_OPENSTACK_PASSWORD]
[infra.variable.FREY_OPENSTACK_AUTH_URL]
[infra.variable.FREY_OPENSTACK_EXTERNAL_GATEWAY]
[infra.variable.FREY__RUNTIME__SSH__KEYPUB_FILE]
[infra.variable.FREY__RUNTIME__SSH__KEYPRV_FILE]
[infra.variable.FREY__RUNTIME__SSH__USER]

[infra.output.public_address]
  value = "${openstack_compute_instance_v2.freytest_app.access_ip_v4}"

[infra.provider.openstack]
  tenant_name = "${var.FREY_OPENSTACK_TENANT_NAME}"
  user_name   = "${var.FREY_OPENSTACK_PROJECT_NAME}"
  password    = "${var.FREY_OPENSTACK_PASSWORD}"
  auth_url    = "${var.FREY_OPENSTACK_AUTH_URL}"

[infra.resource.openstack_compute_floatingip_v2.freytest_app]
  depends_on = ["openstack_networking_router_interface_v2.freytest_app"]
  pool       = "public"

[infra.resource.openstack_compute_instance_v2.freytest_app]
  flavor_name     = "m1.small"
  floating_ip     = "${openstack_compute_floatingip_v2.freytest_app.address}"
  image_name      = "ubuntu14.04-LTS"
  key_pair        = "${openstack_compute_keypair_v2.freytest.name}"
  name            = "freytest_app"
  security_groups = ["${openstack_compute_secgroup_v2.freytest.name}"]
  [infra.resource.openstack_compute_instance_v2.freytest_app.network]
    uuid = "${openstack_networking_network_v2.freytest.id}"

  [infra.resource.openstack_compute_instance_v2.freytest_app.provisioner.remote-exec]
    inline = [
      "sudo pwd",
    ]
    [infra.resource.openstack_compute_instance_v2.freytest_app.provisioner.remote-exec.connection]
      key_file = "${var.FREY__RUNTIME__SSH__KEYPRV_FILE}"
      user     = "${var.FREY__RUNTIME__SSH__USER}"

[infra.resource.openstack_compute_keypair_v2.freytest]
  name       = "freytest-keypair-1"
  public_key = "${file(var.FREY__RUNTIME__SSH__KEYPUB_FILE)}"

[infra.resource.openstack_compute_secgroup_v2.freytest]
  description = "Security group for the Terraform example instances"
  name        = "freytest"
  [[infra.resource.openstack_compute_secgroup_v2.freytest.rule]]
    cidr        = "0.0.0.0/0"
    from_port   = -1
    ip_protocol = "icmp"
    to_port     = -1
  [[infra.resource.openstack_compute_secgroup_v2.freytest.rule]]
    cidr        = "0.0.0.0/0"
    from_port   = 22
    ip_protocol = "tcp"
    to_port     = 22

[infra.resource.openstack_networking_network_v2.freytest]
  admin_state_up = "true"
  name           = "freytest"

[infra.resource.openstack_networking_router_interface_v2.freytest_app]
  router_id = "${openstack_networking_router_v2.freytest.id}"
  subnet_id = "${openstack_networking_subnet_v2.freytest.id}"

[infra.resource.openstack_networking_router_v2.freytest]
  admin_state_up   = "true"
  external_gateway = "${var.FREY_OPENSTACK_EXTERNAL_GATEWAY}"
  name             = "freytest"

[infra.resource.openstack_networking_subnet_v2.freytest]
  cidr            = "10.0.0.0/24"
  dns_nameservers = ["8.8.8.8", "8.8.4.4"]
  ip_version      = 4
  name            = "freytest"
  network_id      = "${openstack_networking_network_v2.freytest.id}"


[install.config.defaults]

[install.config.ssh_connection]
  ssh_args = '-oControlMaster=auto -oControlPersist=60s -oUserKnownHostsFile=/dev/null -oStrictHostKeyChecking=no'

[[install.playbooks]]
  hosts = "freytest_app"
  name  = "Install infra-tusd-server"

[[install.playbooks.tasks]]
  apt_repository = "repo='{{ item }}' state=present"
  with_items     = [
    "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }} main restricted universe multiverse",
    "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }}-updates main restricted universe multiverse",
    "deb http://us.archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }}-security main restricted universe multiverse",
  ]
  name           = "Common | Add APT sources"
  register       = "apt_sources"
