[global.terraform]
  parallelism = 1

[infra.variable.FREY_OPENSTACK_TENANT_NAME]
[infra.variable.FREY_OPENSTACK_PROJECT_NAME]
[infra.variable.FREY_OPENSTACK_PASSWORD]
[infra.variable.FREY_OPENSTACK_AUTH_URL]
[infra.variable.FREY_OPENSTACK_EXTERNAL_GATEWAY]
[infra.variable.FREY__RUNTIME__SSH__KEYPUB_FILE]
[infra.variable.FREY__RUNTIME__SSH__KEYPRV_FILE]
[infra.variable.FREY__RUNTIME__SSH__USER]

[infra.output.public_address]
  value = "${openstack_compute_instance_v2.freytest_app.access_ip_v4}"

# Openstack
[infra.provider.openstack]
  tenant_name = "${var.FREY_OPENSTACK_TENANT_NAME}"
  user_name   = "${var.FREY_OPENSTACK_PROJECT_NAME}"
  password    = "${var.FREY_OPENSTACK_PASSWORD}"
  auth_url    = "${var.FREY_OPENSTACK_AUTH_URL}"

# keypair
[infra.resource.openstack_compute_keypair_v2.freytest]
  name       = "freytest"
  public_key = "${file(var.FREY__RUNTIME__SSH__KEYPUB_FILE)}"

# network
[infra.resource.openstack_networking_network_v2.freytest]
  admin_state_up = "true"
  name           = "freytest"
  # This helps guarantee launch order - useful for acceptance tests:
  depends_on     = [ "openstack_compute_keypair_v2.freytest" ]

# subnet
[infra.resource.openstack_networking_subnet_v2.freytest]
  cidr            = "10.0.0.0/24"
  dns_nameservers = ["8.8.8.8", "8.8.4.4"]
  ip_version      = 4
  network_id      = "${openstack_networking_network_v2.freytest.id}"
  name           = "freytest"
  # This helps guarantee launch order - useful for acceptance tests:
  depends_on     = [ "openstack_compute_secgroup_v2.freytest" ]

# router
[infra.resource.openstack_networking_router_v2.freytest]
  admin_state_up   = "true"
  external_gateway = "${var.FREY_OPENSTACK_EXTERNAL_GATEWAY}"
  name             = "freytest"
  # This helps guarantee launch order - useful for acceptance tests:
  depends_on     = [ "openstack_networking_subnet_v2.freytest" ]

# router_interface
[infra.resource.openstack_networking_router_interface_v2.freytest_app]
  router_id = "${openstack_networking_router_v2.freytest.id}"
  subnet_id = "${openstack_networking_subnet_v2.freytest.id}"

# floatingip
[infra.resource.openstack_compute_floatingip_v2.freytest_app]
  depends_on = ["openstack_networking_router_interface_v2.freytest_app"]
  pool       = "public"

# secgroup
[infra.resource.openstack_compute_secgroup_v2.freytest]
  depends_on  = [ "openstack_networking_network_v2.freytest" ]
  name        = "freytest"
  description = "freytest"
  [[infra.resource.openstack_compute_secgroup_v2.freytest.rule]]
    cidr        = "0.0.0.0/0"
    from_port   = -1
    ip_protocol = "icmp"
    to_port     = -1
  [[infra.resource.openstack_compute_secgroup_v2.freytest.rule]]
    cidr        = "0.0.0.0/0"
    from_port   = 22
    ip_protocol = "tcp"
    to_port     = 22

# instance
[infra.resource.openstack_compute_instance_v2.freytest_app]
  flavor_name     = "m1.small"
  floating_ip     = "${openstack_compute_floatingip_v2.freytest_app.address}"
  image_name      = "ubuntu14.04-LTS"
  key_pair        = "${openstack_compute_keypair_v2.freytest.name}"
  name            = "freytest_app"
  security_groups = ["${openstack_compute_secgroup_v2.freytest.name}"]

  [infra.resource.openstack_compute_instance_v2.freytest_app.network]
    uuid = "${openstack_networking_network_v2.freytest.id}"

  [infra.resource.openstack_compute_instance_v2.freytest_app.provisioner.remote-exec]
    inline = [
      "sudo pwd",
    ]

    [infra.resource.openstack_compute_instance_v2.freytest_app.provisioner.remote-exec.connection]
      key_file = "${var.FREY__RUNTIME__SSH__KEYPRV_FILE}"
      user     = "${var.FREY__RUNTIME__SSH__USER}"


[install.config.defaults]
  # https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg
  remote_user       = "root"
  host_key_checking = "False"

[install.config.ssh_connection]
  ssh_args = "-oControlMaster=auto -oControlPersist=60s -oUserKnownHostsFile=/dev/null -oStrictHostKeyChecking=no"

[[install.playbooks]]
  hosts = "freytest_app"
  name  = "Install app servers"

[[install.playbooks.tasks]]
  name = "Execute arbitrary command"
  command = "pwd"
